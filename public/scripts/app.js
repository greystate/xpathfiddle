// Generated by CoffeeScript 1.3.3
(function() {
  var FiddleController, _ref,
    __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

  this.app = (_ref = window.app) != null ? _ref : {};

  FiddleController = (function() {
    var HELPKEY, TABKEY, XPATHKEY, k;

    FiddleController.PAIRS = {
      39: "''",
      40: "()",
      91: "[]"
    };

    FiddleController.KEYCODES = (function() {
      var _results;
      _results = [];
      for (k in FiddleController.PAIRS) {
        _results.push(+k);
      }
      return _results;
    })();

    TABKEY = 9;

    HELPKEY = 63;

    XPATHKEY = 120;

    FiddleController.COMPLETIONS = {
      "pro": "cessing-instruction('|')",
      "com": "ment()",
      "tex": "t()",
      "nod": "e()",
      "cur": "rent()",
      "pre": "ceding-sibling::",
      "fol": "lowing-sibling::",
      "anc": "estor-or-self::",
      "des": "cendant-or-self::",
      "par": "ent::",
      "norm": "alize-space(|)",
      "gen": "erate-id()",
      "nam": "e()",
      "loc": "al-name()",
      "str": "ing(|)",
      "con": "tains(|)",
      "sta": "rts-with(|)",
      "tr": "anslate(|)",
      "conc": "at(|)",
      "for": "mat-number(|)",
      "pos": "ition()",
      "cou": "nt(|)",
      "cei": "ling(|)",
      "flo": "or(|)",
      "rou": "nd(|)",
      "num": "ber(|)",
      "lan": "g('|')",
      "las": "t()",
      "not": "(|)",
      "bool": "ean(|)",
      "tru": "e()",
      "fal": "se()"
    };

    function FiddleController() {
      this.setup();
    }

    FiddleController.prototype.setup = function() {
      this.focusAndSelect('#xpath');
      ($(".doc-toggle")).on("click", function(e) {
        e.preventDefault();
        return app.controller.toggleFold();
      });
      ($(".help-toggle")).on("click", function(e) {
        e.preventDefault();
        return app.controller.toggleHelp();
      });
      this.assignKeys();
      return this.renderHelpSheetCompletions();
    };

    FiddleController.prototype.toggleFold = function() {
      var $fold;
      $fold = $('#xml-document');
      $fold.toggleClass("out");
      if ($fold.hasClass("out")) {
        return this.focusAndSelect('#xdoc');
      }
    };

    FiddleController.prototype.toggleHelp = function() {
      return ($('body')).toggleClass("showhelp");
    };

    FiddleController.prototype.focusAndSelect = function(field) {
      var $field, DELAY,
        _this = this;
      if (field == null) {
        field = '#xpath';
      }
      DELAY = 300;
      $field = $(field);
      if (field === '#xpath') {
        return window.setTimeout(function() {
          return _this.ignoreInfoInXPathExpression();
        }, DELAY);
      } else {
        return window.setTimeout(function() {
          return $field[0].select();
        }, DELAY);
      }
    };

    FiddleController.prototype.assignKeys = function() {
      var controller;
      controller = this;
      ($('#xpath')).keydown(this.tabCompletion);
      ($('#xpath')).keypress(this.handleKeypress);
      return ($('body')).keypress(this.generalShortcut);
    };

    FiddleController.prototype.tabCompletion = function(event) {
      var $input, caretPos, caretPosInCompletion, completion, pos, shortcut, uptoHere, _ref1, _results;
      if (event.keyCode === TABKEY) {
        $input = $(this);
        pos = $input.getCaretPos();
        uptoHere = $input.val().substring(0, pos - 1);
        _ref1 = FiddleController.COMPLETIONS;
        _results = [];
        for (shortcut in _ref1) {
          completion = _ref1[shortcut];
          if (uptoHere.slice(-shortcut.length) === shortcut) {
            event.preventDefault();
            $input.insertAtCaretPos(completion.replace('|', ''));
            caretPos = $input.getCaretPos();
            caretPosInCompletion = completion.indexOf('|');
            if (caretPosInCompletion >= 0) {
              $input.setCaretPos(caretPos - (completion.length - caretPosInCompletion) + 1);
            } else {
              $input.setCaretPos(caretPos);
            }
            break;
          } else {
            _results.push(void 0);
          }
        }
        return _results;
      }
    };

    FiddleController.prototype.generalShortcut = function(event) {
      switch (event.keyCode) {
        case HELPKEY:
          event.preventDefault();
          return app.controller.toggleHelp();
        case XPATHKEY:
          if (event.target.id !== 'xpath') {
            return app.controller.focusAndSelect('#xpath');
          }
      }
    };

    FiddleController.prototype.handleKeypress = function(event) {
      var $input, code, pair;
      $input = $(this);
      code = event.keyCode;
      if (__indexOf.call(FiddleController.KEYCODES, code) >= 0) {
        event.preventDefault();
        pair = FiddleController.PAIRS[code];
        $input.insertAtCaretPos(pair);
        return $input.setCaretPos($input.getCaretPos() - 1);
      }
    };

    FiddleController.prototype.ignoreInfoInXPathExpression = function() {
      var $input, check, infoRE;
      infoRE = /\s(=>|<--)\s/;
      $input = $('#xpath');
      check = $input.val().match(infoRE);
      return $input.setSelection(0, check ? check.index : $input.val().length);
    };

    FiddleController.prototype.renderHelpSheetCompletions = function() {
      var completion, items, list, shortcut, _ref1;
      items = "";
      _ref1 = FiddleController.COMPLETIONS;
      for (shortcut in _ref1) {
        completion = _ref1[shortcut];
        items += "\n<dt>" + shortcut + " &#x21E5;</dt>\n<dd>" + shortcut + (completion.replace('|', '')) + "</dd>";
      }
      list = $("<h2>TAB completions</h2>\n<dl>" + items + "</dl>");
      return ($('#help')).append(list);
    };

    return FiddleController;

  })();

  $(function() {
    return app.controller = new FiddleController;
  });

}).call(this);
