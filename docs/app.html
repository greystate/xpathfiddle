<!DOCTYPE html>  <html> <head>   <title>app.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               app.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>Global app object </p>             </td>             <td class="code">               <div class="highlight"><pre><span class="vi">@app = </span><span class="nb">window</span><span class="p">.</span><span class="nx">app</span> <span class="o">?</span> <span class="p">{}</span>	</pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Main controller for the page's functions</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">FiddleController</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Character pairs to insert automatically
key is keyCode of trigger, value is characters to insert</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="vi">@PAIRS =</span>
		<span class="mi">39</span> <span class="o">:</span> <span class="s">&quot;&#39;&#39;&quot;</span>
		<span class="mi">40</span> <span class="o">:</span> <span class="s">&quot;()&quot;</span>
		<span class="mi">91</span> <span class="o">:</span> <span class="s">&quot;[]&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Grab the keyCodes for easier lookup later (+k to make sure they're stored as numbers)</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="vi">@KEYCODES = </span><span class="p">(</span><span class="o">+</span><span class="nx">k</span> <span class="k">for</span> <span class="nx">k</span> <span class="k">of</span> <span class="nx">@PAIRS</span><span class="p">)</span>
	</pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>TAB-completions</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">TABKEY = </span><span class="mi">9</span>
	<span class="nv">HELPKEY = </span><span class="mi">63</span>
	<span class="vi">@COMPLETIONS =</span>
		<span class="s">&quot;pro&quot;</span> <span class="o">:</span> <span class="s">&quot;cessing-instruction()&quot;</span>
		<span class="s">&quot;com&quot;</span> <span class="o">:</span> <span class="s">&quot;ment()&quot;</span>
		<span class="s">&quot;tex&quot;</span> <span class="o">:</span> <span class="s">&quot;t()&quot;</span>
		<span class="s">&quot;nod&quot;</span> <span class="o">:</span> <span class="s">&quot;e()&quot;</span>
		<span class="s">&quot;norm&quot;</span><span class="o">:</span> <span class="s">&quot;alize-space()&quot;</span>
		<span class="s">&quot;nam&quot;</span> <span class="o">:</span> <span class="s">&quot;e()&quot;</span>
		<span class="s">&quot;loc&quot;</span> <span class="o">:</span> <span class="s">&quot;al-name()&quot;</span>
		<span class="s">&quot;for&quot;</span> <span class="o">:</span> <span class="s">&quot;mat-number()&quot;</span>
		<span class="s">&quot;pre&quot;</span> <span class="o">:</span> <span class="s">&quot;ceding-sibling::&quot;</span>
		<span class="s">&quot;fol&quot;</span> <span class="o">:</span> <span class="s">&quot;lowing-sibling::&quot;</span>
		<span class="s">&quot;anc&quot;</span> <span class="o">:</span> <span class="s">&quot;estor-or-self::&quot;</span>
		<span class="s">&quot;des&quot;</span> <span class="o">:</span> <span class="s">&quot;cendant-or-self::&quot;</span>
		<span class="s">&quot;lan&quot;</span> <span class="o">:</span> <span class="s">&quot;g()&quot;</span>
		<span class="s">&quot;cur&quot;</span> <span class="o">:</span> <span class="s">&quot;rent()&quot;</span>
		<span class="s">&quot;pos&quot;</span> <span class="o">:</span> <span class="s">&quot;ition()&quot;</span>
		<span class="s">&quot;con&quot;</span> <span class="o">:</span> <span class="s">&quot;tains()&quot;</span>
		<span class="s">&quot;sta&quot;</span> <span class="o">:</span> <span class="s">&quot;rts-with()&quot;</span>
		<span class="s">&quot;conc&quot;</span><span class="o">:</span> <span class="s">&quot;at()&quot;</span>
		<span class="s">&quot;not&quot;</span> <span class="o">:</span> <span class="s">&quot;()&quot;</span>
		<span class="s">&quot;bool&quot;</span><span class="o">:</span> <span class="s">&quot;ean()&quot;</span>
		<span class="s">&quot;num&quot;</span> <span class="o">:</span> <span class="s">&quot;ber()&quot;</span>
		<span class="s">&quot;str&quot;</span> <span class="o">:</span> <span class="s">&quot;ing()&quot;</span>
	
	<span class="nv">constructor: </span><span class="nf">() -&gt;</span>
		<span class="nx">@setup</span><span class="p">()</span>
	</pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Focus the XPath field and select its contents</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">setup: </span><span class="nf">() -&gt;</span>
		<span class="nx">@focusAndSelect</span> <span class="s">&quot;</span><span class="err">#</span><span class="s">xpath&quot;</span>
		<span class="p">(</span><span class="nx">$</span> <span class="s">&quot;.doc-toggle&quot;</span><span class="p">).</span><span class="kc">on</span> <span class="s">&quot;click&quot;</span><span class="p">,</span> <span class="nf">(e) -&gt;</span>
			<span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span>
			<span class="nx">app</span><span class="p">.</span><span class="nx">controller</span><span class="p">.</span><span class="nx">toggleFold</span><span class="p">()</span>
		<span class="p">(</span><span class="nx">$</span> <span class="s">&quot;.help-toggle&quot;</span><span class="p">).</span><span class="kc">on</span> <span class="s">&quot;click&quot;</span><span class="p">,</span> <span class="nf">(e) -&gt;</span>
			<span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span>
			<span class="nx">app</span><span class="p">.</span><span class="nx">controller</span><span class="p">.</span><span class="nx">toggleHelp</span><span class="p">()</span>

		<span class="nx">@assignKeys</span><span class="p">()</span>
		<span class="nx">@renderHelpSheetCompletions</span><span class="p">()</span>
	
	<span class="nv">toggleFold: </span><span class="nf">() -&gt;</span>
		<span class="nv">$fold = </span><span class="nx">$</span> <span class="s">&quot;</span><span class="err">#</span><span class="s">xml-document&quot;</span>
		<span class="nx">$fold</span><span class="p">.</span><span class="nx">toggleClass</span> <span class="s">&quot;out&quot;</span>
		<span class="nx">@focusAndSelect</span> <span class="s">&quot;</span><span class="err">#</span><span class="s">xdoc&quot;</span> <span class="k">if</span> <span class="nx">$fold</span><span class="p">.</span><span class="nx">hasClass</span> <span class="s">&quot;out&quot;</span>
		
	<span class="nv">toggleHelp: </span><span class="nf">() -&gt;</span>
		<span class="p">(</span><span class="nx">$</span> <span class="s">&#39;body&#39;</span><span class="p">).</span><span class="nx">toggleClass</span> <span class="s">&quot;showhelp&quot;</span>

	<span class="nv">focusAndSelect: </span><span class="nf">(field) -&gt;</span>
		<span class="nv">$field = </span><span class="nx">$</span> <span class="nx">field</span>
		<span class="nb">window</span><span class="p">.</span><span class="nx">setTimeout</span> <span class="o">-&gt;</span>
			<span class="nx">$field</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">select</span><span class="p">()</span>
		<span class="p">,</span> <span class="mi">300</span>

	<span class="nv">assignKeys: </span><span class="nf">() -&gt;</span>
		<span class="nv">controller = </span><span class="nx">@</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Handle TAB completions</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="p">(</span><span class="nx">$</span> <span class="s">&#39;#xpath&#39;</span><span class="p">).</span><span class="nx">keydown</span> <span class="nx">@tabCompletion</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Handle smart typing pairs and general shortcuts</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="p">(</span><span class="nx">$</span> <span class="s">&#39;#xpath&#39;</span><span class="p">).</span><span class="nx">keypress</span> <span class="nx">@handleKeypress</span>

	<span class="nv">tabCompletion: </span><span class="nf">(event) -&gt;</span>
		<span class="k">if</span> <span class="nx">event</span><span class="p">.</span><span class="nx">keyCode</span> <span class="o">is</span> <span class="nx">TABKEY</span>
			<span class="nv">$input = </span><span class="nx">$</span> <span class="k">this</span>
			<span class="nv">pos = </span><span class="nx">$input</span><span class="p">.</span><span class="nx">getCaretPos</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Grab the string from start up to the caret position</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nv">uptoHere = </span><span class="nx">$input</span><span class="p">.</span><span class="nx">val</span><span class="p">().</span><span class="nx">substring</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">pos</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Go through the COMPLETIONS</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">for</span> <span class="nx">shortcut</span><span class="p">,</span> <span class="nx">completion</span> <span class="k">of</span> <span class="nx">FiddleController</span><span class="p">.</span><span class="nx">COMPLETIONS</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>If we have a match for the shortcut</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="k">if</span> <span class="nx">uptoHere</span><span class="p">[</span><span class="o">-</span><span class="nx">shortcut</span><span class="p">.</span><span class="nx">length</span><span class="p">...]</span> <span class="o">is</span> <span class="nx">shortcut</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Don't finish the TAB (would exit the input field) </p>             </td>             <td class="code">               <div class="highlight"><pre>					<span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>complete the word/function/etc.</p>             </td>             <td class="code">               <div class="highlight"><pre>					<span class="nx">$input</span><span class="p">.</span><span class="nx">insertAtCaretPos</span> <span class="nx">completion</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <h3>Keyboard Shortcuts</h3>

<ul>
<li>Typing <code>?</code> in the XPath field toggles the Help Sheet</li>
<li><code>[</code>, <code>(</code> and <code>'</code> will trigger insertion of the corresponding <code>]</code>, <code>)</code> or <code>'</code> to complete the pair</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">handleKeypress: </span><span class="nf">(event) -&gt;</span>
		<span class="k">if</span> <span class="nx">event</span><span class="p">.</span><span class="nx">keyCode</span> <span class="o">is</span> <span class="nx">HELPKEY</span>
			<span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span>
			<span class="nx">app</span><span class="p">.</span><span class="nx">controller</span><span class="p">.</span><span class="nx">toggleHelp</span><span class="p">()</span>
		<span class="k">else</span>
			<span class="nv">$input = </span><span class="nx">$</span> <span class="k">this</span>
			<span class="nv">code = </span><span class="nx">event</span><span class="p">.</span><span class="nx">keyCode</span>
		
			<span class="k">if</span> <span class="nx">code</span> <span class="k">in</span> <span class="nx">FiddleController</span><span class="p">.</span><span class="nx">KEYCODES</span>
				<span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span>
				<span class="nv">pair = </span><span class="nx">FiddleController</span><span class="p">.</span><span class="nx">PAIRS</span><span class="p">[</span><span class="nx">code</span><span class="p">]</span>
				<span class="nx">$input</span><span class="p">.</span><span class="nx">insertAtCaretPos</span> <span class="nx">pair</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>looks wrong, but it works...</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="nx">$input</span><span class="p">.</span><span class="nx">setCaretPos</span> <span class="nx">$input</span><span class="p">.</span><span class="nx">getCaretPos</span><span class="p">()</span>
	
	<span class="nv">sendCharacters: </span><span class="nf">(chars) -&gt;</span>
		<span class="nv">oldValue = </span><span class="p">(</span><span class="nx">$</span> <span class="s">&#39;#xpath&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span>
		<span class="p">(</span><span class="nx">$</span> <span class="s">&#39;#xpath&#39;</span><span class="p">).</span><span class="nx">val</span> <span class="nx">oldValue</span> <span class="o">+</span> <span class="nx">chars</span>
		
	<span class="nv">renderHelpSheetCompletions: </span><span class="o">-&gt;</span>
		<span class="nv">items = </span><span class="s">&quot;&quot;</span>
		<span class="nx">items</span> <span class="o">+=</span> <span class="p">(</span><span class="s">&quot;\n&lt;dt&gt;</span><span class="si">#{</span><span class="nx">shortcut</span><span class="si">}</span><span class="s"> &amp;</span><span class="err">#</span><span class="s">x21E5;&lt;/dt&gt;\n&lt;dd&gt;</span><span class="si">#{</span><span class="nx">shortcut</span><span class="si">}#{</span><span class="nx">completion</span><span class="si">}</span><span class="s">&lt;/dd&gt;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="nx">shortcut</span><span class="p">,</span> <span class="nx">completion</span> <span class="k">of</span> <span class="nx">FiddleController</span><span class="p">.</span><span class="nx">COMPLETIONS</span> 
		<span class="nv">list = </span><span class="nx">$</span> <span class="s">&quot;&lt;h2&gt;TAB completions&lt;/h2&gt;\n&lt;dl&gt;</span><span class="si">#{</span><span class="nx">items</span><span class="si">}</span><span class="s">&lt;/dl&gt;&quot;</span>
		<span class="p">(</span><span class="nx">$</span> <span class="s">&#39;#help&#39;</span><span class="p">).</span><span class="nx">append</span> <span class="nx">list</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Start everything when the page is ready</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">$</span> <span class="o">-&gt;</span>
	<span class="nv">app.controller = </span><span class="k">new</span> <span class="nx">FiddleController</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 